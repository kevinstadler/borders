<!DOCTYPE html>
<html lang="en">
  <head>
    <title>borders</title>
    <base target="_blank">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-96498670-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-96498670-1');
    </script>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
    <style>
      body {
        font-family: sans-serif;
        width: 90%;
        margin: auto;
        text-align: justify;
      }
      .map {
        width: 80%;
        margin: auto;
        padding: 20px;
      }
      .right {
        text-align: right;
        display: block;
        width: 80%;
        margin: auto;
      }
    </style>
    <meta property="og:url" content="https://kevinstadler.github.io/borders/" />
    <meta property="og:image" content="https://kevinstadler.github.io/borders/thumbnail.png" />
    <meta property="og:image:secure_url" content="https://kevinstadler.github.io/borders/thumbnail.png" />
  </head>
  <body>
    <div id="map" class="map">
      <noscript><img src="thumbnail.png" alt="static image of the map which requires javascript to run interactively" title="if you enable javascript, an interactive map will be displayed here!" /></noscript>
    </div>
    <div class="right"><label><input id="labels" type="checkbox" checked>show place names</label> <label id="southup"><input id="southbox" type="checkbox">south up!</label></div>

    <script>
      var labels = document.getElementById("labels");
      var southbox = document.getElementById("southbox");

      var opaqueStyle = new ol.style.Style({
        fill: new ol.style.Fill({
            color: "#000"
        })
      });

      // http://sedac.ciesin.columbia.edu/data/collection/gpw-v4/sets/browse
      var densityLayer = new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: "../gpw-tiles/{z}/{x}/{-y}.png",
          attributions: "NASA Socioeconomic Data and Applications Center (SEDAC)",
          maxZoom: 7
        })
      });
      densityLayer.on("precompose", function(evt) { evt.context.globalCompositeOperation = "source-over" });

      var openMapTiles = new ol.source.VectorTile({
        url: "https://free.tilehosting.com/data/v3/{z}/{x}/{y}.pbf.pict?key=qu62rKisigsebPda2e6b",
        format: new ol.format.MVT(),
        tileGrid: ol.tilegrid.createXYZ({minZoom: 1, maxZoom: 14 }),
        attributions: "&copy; OpenMapTiles &copy; OpenStreetMap contributors"
      });

      var buildingStyle = new ol.style.Style({
        fill: new ol.style.Fill({
            color: "#000a"
        })
      });

      // OpenMapTiles: landuse=residential polygons
      var landUseLayer = new ol.layer.VectorTile({
        source: openMapTiles,
        // landuse included from zoomLevel 4 (resolution 15000), good quality from zoomLevel 9 (resolution 1200)
        minResolution: 0,
        maxResolution: 1200,// for zoomLevel 9

        style: function(feature, resolution) {
//          if (resolution >= 10 && feature.get('layer') == "landuse" && feature.get("class") == "residential") {
//            return transparentStyle;
//          } else
          if (resolution < 20 && feature.get('layer') == "building") {
//            console.log(resolution); // buildings visible from zoomLevel 12 (resolution 20)
            return buildingStyle;
          }
        }
      });
//      console.log(landUseLayer.getSource().getTileGrid().getResolutions());
      // big change 8.4 463 > 8.42 458, also 12 - 13 (31-27 resolution)
      landUseLayer.on("precompose", function(evt) { evt.context.globalCompositeOperation = "source-over" });

//      var sevencols = [[228,26,28], [55,126,184], [77,175,74], [152,78,163], [255,127,0], [255,255,51], [166,86,40]];
      var sevencols = [[0, 130, 200], [245, 130, 48], [145, 30, 180], [60, 180, 75], [170, 110, 40], [128, 0, 0], [128, 158, 0]];

      function communityStyle(feature, resolution) {
        return new ol.style.Style({
          fill: new ol.style.Fill({
            color: sevencols[feature.get("color7") - 1]
          })
        });
      }

      var communitySource = new ol.source.VectorTile({
        url: "../osm-admin-boundary-vector-tiles/{z}/{x}/{y}.pbf",
        format: new ol.format.MVT(),
        maxZoom: 10
      });

      var communityLayer = new ol.layer.VectorTile({
        source: communitySource,
        style: communityStyle
      });
      communityLayer.on("precompose", function(evt) {evt.context.globalCompositeOperation = "source-in" });

      var waterLayer = new ol.layer.VectorTile({
        source: openMapTiles,
        style: function(feature, resolution) {
          if (feature.get("layer") == "water") {
            return opaqueStyle;
          }
        }
      })
      waterLayer.on("precompose", function(evt) {evt.context.globalCompositeOperation = "destination-out" });

      var labelLayer = new ol.layer.VectorTile({
        source: communitySource,
        minResolution: 800,
        maxResolution: 10000,
        style: (function() {
          var style = new ol.style.Style({
            text: new ol.style.Text({
              fill: new ol.style.Fill({ color: "#fff" }),
              font: "14px sans-serif"
            })
          });
          return function(feature, resolution) {
            style.getText().setText(feature.get("locname"));
            // currently just writing it in ghostly white, but many other
            // variations possible (e.g. set text stroke to community colour?)
            return style;
          }
        })()
      });
      labelLayer.on("precompose", function(evt) { evt.context.globalCompositeOperation = "source-atop" });

      var labelLayer2 = new ol.layer.VectorTile({
        source: openMapTiles,
        minResolution: 20,
        maxResolution: 800,
        style: (function() {
          var style = new ol.style.Style({
            text: new ol.style.Text({
              fill: new ol.style.Fill({ color: "#fff" }),
              font: "italic 12px sans-serif"
            })
          });
          return function(feature, resolution) {
            // TODO town, village, hamlet, suburb, neighbourhood, isolated_dwelling
            if (feature.get('layer') == "place" && feature.get("class") == "city" && feature.get("rank") <= map.getView().getZoom()) {
              style.getText().setText(feature.get("name"));
              return style;
            }
          }
        })()
      });
      labelLayer2.on("precompose", function(evt) { evt.context.globalCompositeOperation = "source-atop" });

      var backgroundLayer = new ol.layer.Tile({
        source: new ol.source.BingMaps({
          key: "AnzJ8GUrq-Q-tkdVYWFWs-3H9pIyykpZBwnLXyGTXDA8WV6-1kg-veWxC9XBpMAt",
          imagerySet: "Aerial",
          maxZoom: 19
        })
      });
      // background drawn behind polygons
      backgroundLayer.on("precompose", function(evt) { evt.context.globalCompositeOperation = "destination-over" });

      var zoom = 2;
      var center = ol.proj.fromLonLat([0, 0]);
      var rotation = 0;

      if (window.location.hash !== '') {
        // try to restore center, zoom-level and rotation from the URL
        var hash = window.location.hash.replace('#map=', '');
        var parts = hash.split('/');
        if (parts.length === 4) {
          zoom = parseInt(parts[0], 10);
          center = ol.proj.fromLonLat([parseFloat(parts[1]), parseFloat(parts[2])]);
          rotation = parseInt(parts[3], 10);
          if (rotation == 180) {
            southbox.checked = true;
          }
          rotation = rotation * Math.PI / 180;
        }
      }

      var map = new ol.Map({
        layers: [
          densityLayer,
          landUseLayer,
          communityLayer,
          waterLayer,
          labelLayer,
          labelLayer2,
          backgroundLayer
        ],
        controls: ol.control.defaults().extend([new ol.control.ScaleLine()]),
        target: 'map',
        view: new ol.View({
          projection: "EPSG:3857",
          zoom: zoom,
//          extent: [-20037508.342789244, -9608371.50993366, 20037508.342789244, 19971868.88040853],
          center: center,
          rotation: rotation,
          minZoom: 2,
          maxZoom: 19
        })
      });

      function goTo(zoom, lon, lat) {
        map.getView().setZoom(zoom);
        map.getView().setCenter(ol.proj.fromLonLat([lon, lat]));
//        map.getView().setRotation(rotation);
      }

      labels.onchange = function() {
        labelLayer.setVisible(labels.checked);
        labelLayer2.setVisible(labels.checked);
      }

      southbox.onchange = function() {
        if (southbox.checked) {
          map.getView().setRotation(Math.PI);
        } else {
          map.getView().setRotation(0);
        }
        gtag("event", "southup", {"value": southbox.checked});
      }

      var resolutionThresholds = [20, 100, 500, 3000, 4000, Infinity];
      var opacityLevels = [0.35, 0.4, 0.5, 0.6, 0.8, 1.0];

      map.on("moveend", function(evt) {
        var view = map.getView();

        // change population density opacity depending on zoomlevel
        var i = resolutionThresholds.findIndex(function(threshold) { return view.getResolution() < threshold });
        densityLayer.setOpacity(opacityLevels[i]);

        var center = ol.proj.toLonLat(view.getCenter());
        var hash = "#map=" + Math.round(view.getZoom()) + "/" + (Math.round(center[0]*1000) / 1000) + "/" + (Math.round(center[1]*1000) / 1000) + "/" + Math.round(view.getRotation() * 180 / Math.PI);
        location.hash = hash;
        // TODO uncheck southbox
        gtag("event", "move", {"value": hash});
      });
    </script>
    <p>On maps produced in modern times, nation states and other geo-political bodies are typically shown as homogeneous slabs that extend all the way to where they meet up with either neighbouring nations or the sea, resulting in well-defined border outlines. What such depictions represent is really the <em>theoretical</em> extent of the territory over which a government claims <a href="https://en.wikipedia.org/wiki/Sovereignty">sovereign</a> authority, independently of whether (or how much) this authority is actually exercised. Questions such as which country or state is "the biggest" are misleading in that they don't acknowledge that large swathes of the claimed area might be of little interest to humans, and therefore completely uninhabited and uncontrolled. This map explores a more meaningful way of conceiving of a nation in social terms, namely as the <a href="https://en.wikipedia.org/wiki/Imagined_community">imagined community</a> of individuals who consider themselves to belong to the same country. Only colouring in areas where there is actual human habitation reveals that not all borders are alike: abrupt ones might follow <a href="#map" onclick="goTo(11, -8.61, 41.99)" target="_self">"natural" boundary features</a> or else require <a href="#map" onclick="goTo(13, -117.05, 32.54)" target="_self">strict policing</a> along <a href="#map" onclick="goTo(11, -122.93, 48.98)" target="_self">awkwardly arbitrary</a> or downright <a href="#map" onclick="goTo(14, 4.93, 51.44)" target="_self">unenforceable</a> boundary lines, while more <em>frontier</em>-like border regions can also be more or <a href="#map" onclick="goTo(9, 11.31, 46.94)" target="_self">less</a> penetrable in nature.</p><!-- imperceptible: goTo(13, -101.52, 49) -->
    <div class="right"><a href="/"><img src="https://img.shields.io/badge/about-me-lightgrey.svg" alt="about me" title="about me"/></a> <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=2JE6FCBYY94LJ"><img src="https://img.shields.io/badge/donate-paypal%20($)-blue.svg" alt="Donate US Dollars" title="thank you for chipping in for hosting costs!" /></a> <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=WKKFFM6D7ZHEE"><img src="https://img.shields.io/badge/donate-paypal%20(%E2%82%AC)-blue.svg" alt="Donate Euro" title="thank you for chipping in for hosting costs!" /></a></div>
    <!--h2>Reading</h2>

    <p></p-->

  </body>
</html>
